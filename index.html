<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IcarStok - Controle de Estoque com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-900 */
        }
        /* Estilos personalizados para a fonte */
        .font-inter {
            font-family: 'Inter', sans-serif;
        }
        /* Esconder seções por padrão */
        .content-section:not(.active) {
            display: none;
        }
        /* Estilo para botões de ação */
        .btn-primary {
            @apply px-4 py-2 rounded-md shadow-sm transition-colors duration-200;
        }
        /* Cores alteradas para verde */
        .btn-green-theme {
            @apply bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2;
        }
        .btn-green {
            @apply bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2;
        }
        .btn-red {
            @apply bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2;
        }
        .btn-blue {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2;
        }
        .btn-gray {
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400;
        }
        /* Estilo para inputs */
        .input-field {
            /* Cores de foco alteradas para verde */
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm p-2;
        }
        /* Estilo para tabelas */
        .table-header {
            @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        .table-cell {
            @apply px-6 py-4 whitespace-nowrap text-sm;
        }
        .table-cell-text {
            @apply font-medium text-gray-900;
        }
        .table-cell-subtext {
            @apply text-gray-500;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-inter">

    <header class="bg-gradient-to-r from-green-600 to-emerald-700 text-white shadow-lg p-4">
        <div class="container mx-auto flex flex-wrap items-center justify-between">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                    <path fill-rule="evenodd" d="M3.75 6.75a3 3 0 0 0-3 3v6a3 3 0 0 0 3 3h16.5a3 3 0 0 0 3-3v-6a3 3 0 0 0-3-3H3.75zM7.5 9a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H7.5zm2.25 0a.75.75 0 0 0 0 1.5H9.758a.75.75 0 0 0 0-1.5H9.75zm2.25 0a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H12zm2.25 0a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H14.25zm2.25 0a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H16.5zm-4.5 3a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H12zm2.25 0a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H14.25zm2.25 0a.75.75 0 0 0 0 1.5h.008a.75.75 0 0 0 0-1.5H16.5z" clip-rule="evenodd" />
                </svg>
                <h1 class="text-3xl font-extrabold tracking-tight">IcarStok</h1>
            </div>
            <nav id="main-nav" class="mt-4 md:mt-0 hidden"> <ul class="flex flex-wrap space-x-4 md:space-x-6">
                    <li><button data-target="dashboard-section" class="nav-tab px-4 py-2 rounded-md transition-colors duration-200">Dashboard</button></li>
                    <li><button data-target="products-section" class="nav-tab px-4 py-2 rounded-md transition-colors duration-200">Produtos</button></li>
                    <li><button data-target="suppliers-section" class="nav-tab px-4 py-2 rounded-md transition-colors duration-200">Fornecedores</button></li>
                    <li><button data-target="sales-section" class="nav-tab px-4 py-2 rounded-md transition-colors duration-200">Vendas</button></li>
                    <li><button data-target="purchases-section" class="nav-tab px-4 py-2 rounded-md transition-colors duration-200">Compras</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow">
        <div id="user-info-display" class="mb-4 hidden">
            <div class="p-4 bg-gray-100 rounded-lg shadow-inner text-sm text-gray-700 break-words flex justify-between items-center">
                <div>
                    <p class="font-semibold">ID do Usuário (para demonstração):</p>
                    <p id="user-id-text" class="text-gray-600">Carregando...</p>
                </div>
                <button id="logout-button" class="ml-4 px-4 py-2 bg-red-500 text-white rounded-md shadow hover:bg-red-600 transition-colors duration-200">Sair</button>
            </div>
        </div>

        <div id="loading-spinner" class="hidden flex justify-center items-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
        </div>

        <div id="firebase-error-display" class="hidden text-red-600 text-center p-8 text-lg"></div>

        <section id="auth-forms-section" class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
            <div id="login-form-container" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Login IcarStok</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" required class="input-field">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="login-password" required class="input-field">
                    </div>
                    <button type="submit" id="login-button" class="w-full py-3 px-4 btn-primary btn-green-theme">Entrar</button>
                </form>
                <p class="mt-6 text-center text-gray-600">
                    Não tem uma conta?
                    <button id="switch-to-register" class="text-green-600 hover:text-green-800 font-semibold focus:outline-none">Cadastre-se</button>
                </p>
            </div>

            <div id="register-form-container" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Cadastro IcarStok</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="register-email" required class="input-field">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="register-password" required class="input-field">
                    </div>
                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Senha</label>
                        <input type="password" id="confirm-password" required class="input-field">
                    </div>
                    <button type="submit" id="register-button" class="w-full py-3 px-4 btn-primary btn-green">Cadastrar</button>
                </form>
                <p class="mt-6 text-center text-gray-600">
                    Já tem uma conta?
                    <button id="switch-to-login" class="text-green-600 hover:text-green-800 font-semibold focus:outline-none">Faça Login</button>
                </p>
            </div>
        </section>

        <section id="dashboard-section" class="content-section p-6 bg-white rounded-lg shadow-md active">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-100 p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-blue-800">Valor Total do Estoque</h3>
                    <p id="total-stock-value" class="text-3xl font-bold text-blue-900">R$ 0.00</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-yellow-800">Produtos com Estoque Baixo</h3>
                    <p id="low-stock-products-count" class="text-3xl font-bold text-yellow-900">0</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-green-800">Valor Total de Vendas</h3>
                    <p id="total-sales-value" class="text-3xl font-bold text-green-900">R$ 0.00</p>
                </div>
            </div>

            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ações de IA</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <button id="predict-demand-btn" class="btn-primary bg-green-600 hover:bg-green-700">Prever Demanda</button>
                <button id="optimize-replenishment-btn" class="btn-primary bg-emerald-600 hover:bg-emerald-700">Otimizar Reabastecimento</button>
                <button id="detect-anomalies-btn" class="btn-primary bg-red-600">Detectar Anomalias</button>
                <button id="analyze-performance-btn" class="btn-primary bg-lime-600 hover:bg-lime-700">Analisar Desempenho de Produtos</button>
            </div>

            <div id="ai-predictions-output" class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Resultados da IA: <span id="ai-prediction-type"></span></h3>
                <pre id="ai-prediction-data" class="bg-gray-100 p-4 rounded-md text-sm overflow-auto max-h-60"></pre>
            </div>
        </section>

        <section id="products-section" class="content-section p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Gestão de Produtos</h2>

            <form id="product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="col-span-full">
                    <h3 id="product-form-title" class="text-xl font-semibold text-gray-700 mb-4">Adicionar Novo Produto</h3>
                </div>
                <div><label for="product-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="product-name" name="name" required class="input-field"></div>
                <div><label for="product-description" class="block text-sm font-medium text-gray-700">Descrição</label><input type="text" id="product-description" name="description" class="input-field"></div>
                <div><label for="product-sku" class="block text-sm font-medium text-gray-700">SKU</label><input type="text" id="product-sku" name="sku" required class="input-field"></div>
                <div><label for="product-category" class="block text-sm font-medium text-gray-700">Categoria</label><input type="text" id="product-category" name="category" class="input-field"></div>
                <div><label for="product-cost-price" class="block text-sm font-medium text-gray-700">Preço de Custo</label><input type="number" id="product-cost-price" name="costPrice" required class="input-field"></div>
                <div><label for="product-sale-price" class="block text-sm font-medium text-gray-700">Preço de Venda</label><input type="number" id="product-sale-price" name="salePrice" required class="input-field"></div>
                <div><label for="product-current-stock" class="block text-sm font-medium text-gray-700">Estoque Atual</label><input type="number" id="product-current-stock" name="currentStock" required class="input-field"></div>
                <div><label for="product-min-stock" class="block text-sm font-medium text-gray-700">Estoque Mínimo</label><input type="number" id="product-min-stock" name="minStock" required class="input-field"></div>
                <div><label for="product-supplier-id" class="block text-sm font-medium text-gray-700">Fornecedor</label><select id="product-supplier-id" name="supplierId" class="input-field"></select></div>
                <div class="col-span-full flex justify-end space-x-2">
                    <button type="submit" id="product-submit-btn" class="btn-primary btn-green-theme">Adicionar Produto</button>
                    <button type="button" id="product-cancel-edit-btn" class="btn-primary btn-gray hidden">Cancelar</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold text-gray-800 mb-4">Lista de Produtos</h3>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="table-header">Nome</th>
                            <th scope="col" class="table-header">SKU</th>
                            <th scope="col" class="table-header">Estoque Atual</th>
                            <th scope="col" class="table-header">Estoque Mínimo</th>
                            <th scope="col" class="table-header">Preço Venda</th>
                            <th scope="col" class="table-header">Fornecedor</th>
                            <th scope="col" class="table-header">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="7" class="table-cell table-cell-subtext text-center">Nenhum produto cadastrado.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="suppliers-section" class="content-section p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Gestão de Fornecedores</h2>

            <form id="supplier-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="col-span-full">
                    <h3 id="supplier-form-title" class="text-xl font-semibold text-gray-700 mb-4">Adicionar Novo Fornecedor</h3>
                </div>
                <div><label for="supplier-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="supplier-name" name="name" required class="input-field"></div>
                <div><label for="supplier-contact" class="block text-sm font-medium text-gray-700">Contato</label><input type="text" id="supplier-contact" name="contact" class="input-field"></div>
                <div><label for="supplier-address" class="block text-sm font-medium text-gray-700">Endereço</label><input type="text" id="supplier-address" name="address" class="input-field"></div>
                <div><label for="supplier-payment-terms" class="block text-sm font-medium text-gray-700">Termos de Pagamento</label><input type="text" id="supplier-payment-terms" name="paymentTerms" class="input-field"></div>
                <div class="col-span-full flex justify-end space-x-2">
                    <button type="submit" id="supplier-submit-btn" class="btn-primary btn-green-theme">Adicionar Fornecedor</button>
                    <button type="button" id="supplier-cancel-edit-btn" class="btn-primary btn-gray hidden">Cancelar</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold text-gray-800 mb-4">Lista de Fornecedores</h3>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="table-header">Nome</th>
                            <th scope="col" class="table-header">Contato</th>
                            <th scope="col" class="table-header">Endereço</th>
                            <th scope="col" class="table-header">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="suppliers-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="table-cell table-cell-subtext text-center">Nenhum fornecedor cadastrado.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="sales-section" class="content-section p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Gestão de Vendas</h2>

            <form id="sale-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="col-span-full">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Registrar Nova Venda</h3>
                </div>
                <div><label for="sale-product-id" class="block text-sm font-medium text-gray-700">Produto</label><select id="sale-product-id" name="productId" required class="input-field"></select></div>
                <div><label for="sale-quantity" class="block text-sm font-medium text-gray-700">Quantidade</label><input type="number" id="sale-quantity" name="quantity" required min="1" class="input-field"></div>
                <div><label for="sale-price" class="block text-sm font-medium text-gray-700">Preço de Venda (por unidade)</label><input type="number" id="sale-price" name="salePrice" required class="input-field"></div>
                <div><label for="sale-date" class="block text-sm font-medium text-gray-700">Data da Venda</label><input type="date" id="sale-date" name="saleDate" required class="input-field"></div>
                <div class="col-span-full flex justify-end">
                    <button type="submit" class="btn-primary btn-green">Registrar Venda</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold text-gray-800 mb-4">Histórico de Vendas</h3>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="table-header">Produto</th>
                            <th scope="col" class="table-header">Quantidade</th>
                            <th scope="col" class="table-header">Preço Total</th>
                            <th scope="col" class="table-header">Data</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="table-cell table-cell-subtext text-center">Nenhuma venda registrada.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="purchases-section" class="content-section p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Gestão de Compras</h2>

            <form id="purchase-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="col-span-full">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Registrar Nova Compra</h3>
                </div>
                <div><label for="purchase-product-id" class="block text-sm font-medium text-gray-700">Produto</label><select id="purchase-product-id" name="productId" required class="input-field"></select></div>
                <div><label for="purchase-supplier-id" class="block text-sm font-medium text-gray-700">Fornecedor</label><select id="purchase-supplier-id" name="supplierId" required class="input-field"></select></div>
                <div><label for="purchase-quantity" class="block text-sm font-medium text-gray-700">Quantidade</label><input type="number" id="purchase-quantity" name="quantity" required min="1" class="input-field"></div>
                <div><label for="purchase-cost-price" class="block text-sm font-medium text-gray-700">Preço de Custo (por unidade)</label><input type="number" id="purchase-cost-price" name="costPrice" required class="input-field"></div>
                <div><label for="purchase-date" class="block text-sm font-medium text-gray-700">Data da Compra</label><input type="date" id="purchase-date" name="purchaseDate" required class="input-field"></div>
                <div class="col-span-full flex justify-end">
                    <button type="submit" class="btn-primary btn-blue">Registrar Compra</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold text-gray-800 mb-4">Histórico de Compras</h3>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="table-header">Produto</th>
                            <th scope="col" class="table-header">Fornecedor</th>
                            <th scope="col" class="table-header">Quantidade</th>
                            <th scope="col" class="table-header">Preço Total</th>
                            <th scope="col" class="table-header">Data</th>
                        </tr>
                    </thead>
                    <tbody id="purchases-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="table-cell table-cell-subtext text-center">Nenhuma compra registrada.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p>&copy; <span id="current-year"></span> IcarStok. Todos os direitos reservados.</p>
    </footer>

    <div id="modal-container" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div id="modal-content" class="rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg font-semibold mb-4"></p>
            <button id="modal-close-button" class="mt-4 px-6 py-2 bg-white text-gray-800 rounded-md shadow hover:bg-gray-100 transition-colors duration-200">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration (REQUIRED: Replace with your actual Firebase project config) ---
        // You can find this in your Firebase Console -> Project settings -> Your apps -> Web app
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID", // This is the web app ID
            measurementId: "YOUR_FIREBASE_MEASUREMENT_ID"
        };

        // --- Gemini API Key (REQUIRED: Replace with your actual Gemini API Key) ---
        // IMPORTANT: For production, consider using a secure proxy to avoid exposing this key directly in frontend.
        const geminiApiKey = "YOUR_GEMINI_API_KEY";

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentAppIdForFirestorePath = null; // Will store the actual Firebase App ID for Firestore paths

        // Data arrays (simulating state management)
        let products = [];
        let suppliers = [];
        let sales = [];
        let purchases = [];

        // --- UI Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const firebaseErrorDisplay = document.getElementById('firebase-error-display');
        const authFormsSection = document.getElementById('auth-forms-section');
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const mainNav = document.getElementById('main-nav');
        const userInfoDisplay = document.getElementById('user-info-display');
        const userIdText = document.getElementById('user-id-text');
        const logoutButton = document.getElementById('logout-button');
        const navTabs = document.querySelectorAll('.nav-tab');
        const contentSections = document.querySelectorAll('.content-section');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        // --- Modal Functions ---
        function showModal(message, type = 'info') {
            modalMessage.textContent = message;
            modalContent.className = 'rounded-lg shadow-xl p-6 max-w-sm w-full text-center'; // Reset classes
            if (type === 'error') {
                modalContent.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                modalContent.classList.add('bg-green-500', 'text-white');
            } else {
                modalContent.classList.add('bg-blue-500', 'text-white');
            }
            modalContainer.classList.remove('hidden');
        }

        function closeModal() {
            modalContainer.classList.add('hidden');
        }

        modalCloseButton.addEventListener('click', closeModal);

        // --- Loading Spinner Functions ---
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        // --- View Management ---
        function renderView(viewId) {
            contentSections.forEach(section => {
                section.classList.remove('active');
                section.classList.add('hidden'); // Ensure it's hidden with Tailwind
            });
            const targetSection = document.getElementById(viewId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.classList.remove('hidden');
            }

            navTabs.forEach(tab => {
                // Cores da aba de navegação alteradas para verde
                tab.classList.remove('bg-green-700', 'text-white', 'shadow-md');
                tab.classList.add('text-green-100', 'hover:bg-green-500', 'hover:bg-opacity-20');
                if (tab.dataset.target === viewId) {
                    tab.classList.add('bg-green-700', 'text-white', 'shadow-md');
                    tab.classList.remove('text-green-100', 'hover:bg-green-500', 'hover:bg-opacity-20');
                }
            });
        }

        // --- Authentication ---
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            showLoading();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showModal("Login bem-sucedido!", 'success');
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = "Erro ao fazer login. Verifique seu e-mail e senha.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "Usuário não encontrado. Crie uma conta.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Senha incorreta.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "E-mail inválido.";
                }
                showModal(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (password !== confirmPassword) {
                showModal("As senhas não coincidem.", 'error');
                return;
            }

            showLoading();
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showModal("Cadastro bem-sucedido! Faça login.", 'success');
                loginFormContainer.classList.remove('hidden');
                registerFormContainer.classList.add('hidden');
            } catch (error) {
                console.error("Registration error:", error);
                let errorMessage = "Erro ao cadastrar. Tente novamente.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este e-mail já está em uso.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha é muito fraca (mínimo 6 caracteres).";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "E-mail inválido.";
                }
                showModal(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        }

        async function handleLogout() {
            showLoading();
            try {
                await signOut(auth);
                showModal("Logout realizado com sucesso!", 'success');
            } catch (error) {
                console.error("Error logging out:", error);
                showModal(`Erro ao fazer logout: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // --- Data Management (Firestore) ---
        function setupFirestoreListeners(userId) {
            const appId = currentAppIdForFirestorePath;

            // Products Listener
            const productsRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
            onSnapshot(productsRef, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductsTable();
                updateDashboardKPIs();
                populateProductSelects();
            }, (error) => {
                console.error("Erro ao carregar produtos:", error);
                showModal(`Erro ao carregar produtos: ${error.message}`, 'error');
            });

            // Suppliers Listener
            const suppliersRef = collection(db, `artifacts/${appId}/users/${userId}/suppliers`);
            onSnapshot(suppliersRef, (snapshot) => {
                suppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSuppliersTable();
                populateSupplierSelects();
            }, (error) => {
                console.error("Erro ao carregar fornecedores:", error);
                showModal(`Erro ao carregar fornecedores: ${e.message}`, 'error');
            });

            // Sales Listener
            const salesRef = collection(db, `artifacts/${appId}/users/${userId}/sales`);
            onSnapshot(salesRef, (snapshot) => {
                sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSalesTable();
                updateDashboardKPIs();
            }, (error) => {
                console.error("Erro ao carregar vendas:", error);
                showModal(`Erro ao carregar vendas: ${error.message}`, 'error');
            });

            // Purchases Listener
            const purchasesRef = collection(db, `artifacts/${appId}/users/${userId}/purchases`);
            onSnapshot(purchasesRef, (snapshot) => {
                purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPurchasesTable();
            }, (error) => {
                console.error("Erro ao carregar compras:", error);
                showModal(`Erro ao carregar compras: ${error.message}`, 'error');
            });
        }

        // --- CRUD Operations ---
        async function addProduct(productData) {
            showLoading();
            try {
                await addDoc(collection(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/products`), {
                    ...productData,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                });
                showModal("Produto adicionado com sucesso!", 'success');
                document.getElementById('product-form').reset();
            } catch (e) {
                console.error("Erro ao adicionar produto: ", e);
                showModal(`Erro ao adicionar produto: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateProduct(id, productData) {
            showLoading();
            try {
                const productRef = doc(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/products`, id);
                await updateDoc(productRef, {
                    ...productData,
                    updatedAt: serverTimestamp(),
                });
                showModal("Produto atualizado com sucesso!", 'success');
                document.getElementById('product-form').reset();
                document.getElementById('product-form').dataset.editingId = ''; // Clear editing state
                document.getElementById('product-submit-btn').textContent = 'Adicionar Produto';
                document.getElementById('product-form-title').textContent = 'Adicionar Novo Produto';
                document.getElementById('product-cancel-edit-btn').classList.add('hidden');
            } catch (e) {
                console.error("Erro ao atualizar produto: ", e);
                showModal(`Erro ao atualizar produto: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteProduct(id) {
            showLoading();
            try {
                await deleteDoc(doc(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/products`, id));
                showModal("Produto removido com sucesso!", 'success');
            } catch (e) {
                console.error("Erro ao remover produto: ", e);
                showModal(`Erro ao remover produto: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function addSupplier(supplierData) {
            showLoading();
            try {
                await addDoc(collection(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/suppliers`), {
                    ...supplierData,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                });
                showModal("Fornecedor adicionado com sucesso!", 'success');
                document.getElementById('supplier-form').reset();
            } catch (e) {
                console.error("Erro ao adicionar fornecedor: ", e);
                showModal(`Erro ao adicionar fornecedor: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateSupplier(id, supplierData) {
            showLoading();
            try {
                const supplierRef = doc(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/suppliers`, id);
                await updateDoc(supplierRef, {
                    ...supplierData,
                    updatedAt: serverTimestamp(),
                });
                showModal("Fornecedor atualizado com sucesso!", 'success');
                document.getElementById('supplier-form').reset();
                document.getElementById('supplier-form').dataset.editingId = '';
                document.getElementById('supplier-submit-btn').textContent = 'Adicionar Fornecedor';
                document.getElementById('supplier-form-title').textContent = 'Adicionar Novo Fornecedor';
                document.getElementById('supplier-cancel-edit-btn').classList.add('hidden');
            } catch (e) {
                console.error("Erro ao atualizar fornecedor: ", e);
                showModal(`Erro ao atualizar fornecedor: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteSupplier(id) {
            showLoading();
            try {
                await deleteDoc(doc(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/suppliers`, id));
                showModal("Fornecedor removido com sucesso!", 'success');
            } catch (e) {
                console.error("Erro ao remover fornecedor: ", e);
                showModal(`Erro ao remover fornecedor: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function addSale(saleData) {
            showLoading();
            try {
                const product = products.find(p => p.id === saleData.productId);
                if (!product || product.currentStock < saleData.quantity) {
                    showModal("Estoque insuficiente ou produto não encontrado.", 'error');
                    return;
                }

                await addDoc(collection(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/sales`), {
                    ...saleData,
                    saleDate: new Date(saleData.saleDate),
                    createdAt: serverTimestamp(),
                });

                await updateDoc(doc(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/products`, saleData.productId), {
                    currentStock: product.currentStock - saleData.quantity,
                    updatedAt: serverTimestamp(),
                });

                showModal("Venda registrada com sucesso e estoque atualizado!", 'success');
                document.getElementById('sale-form').reset();
            } catch (e) {
                console.error("Erro ao registrar venda: ", e);
                showModal(`Erro ao registrar venda: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function addPurchase(purchaseData) {
            showLoading();
            try {
                const product = products.find(p => p.id === purchaseData.productId);
                if (!product) {
                    showModal("Produto não encontrado.", 'error');
                    return;
                }

                await addDoc(collection(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/purchases`), {
                    ...purchaseData,
                    purchaseDate: new Date(purchaseData.purchaseDate),
                    createdAt: serverTimestamp(),
                });

                await updateDoc(doc(db, `artifacts/${currentAppIdForFirestorePath}/users/${currentUserId}/products`, purchaseData.productId), {
                    currentStock: product.currentStock + purchaseData.quantity,
                    updatedAt: serverTimestamp(),
                });

                showModal("Compra registrada com sucesso e estoque atualizado!", 'success');
                document.getElementById('purchase-form').reset();
            } catch (e) {
                console.error("Erro ao registrar compra: ", e);
                showModal(`Erro ao registrar compra: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // --- Rendering Functions ---
        function renderProductsTable() {
            const tableBody = document.getElementById('products-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="table-cell table-cell-subtext text-center">Nenhum produto cadastrado.</td></tr>';
                return;
            }

            products.forEach(product => {
                const supplierName = suppliers.find(s => s.id === product.supplierId)?.name || 'N/A';
                const row = `
                    <tr>
                        <td class="table-cell table-cell-text">${product.name}</td>
                        <td class="table-cell table-cell-subtext">${product.sku}</td>
                        <td class="table-cell table-cell-subtext">${product.currentStock}</td>
                        <td class="table-cell table-cell-subtext">${product.minStock}</td>
                        <td class="table-cell table-cell-subtext">R$ ${product.salePrice ? product.salePrice.toFixed(2) : '0.00'}</td>
                        <td class="table-cell table-cell-subtext">${supplierName}</td>
                        <td class="table-cell text-right text-sm font-medium">
                            <button data-id="${product.id}" class="edit-product-btn text-green-600 hover:text-green-900 mr-4">Editar</button>
                            <button data-id="${product.id}" class="delete-product-btn text-red-600 hover:text-red-900">Remover</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // Add event listeners for new buttons
            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.id;
                    const productToEdit = products.find(p => p.id === productId);
                    if (productToEdit) {
                        document.getElementById('product-form').dataset.editingId = productId;
                        document.getElementById('product-name').value = productToEdit.name;
                        document.getElementById('product-description').value = productToEdit.description;
                        document.getElementById('product-sku').value = productToEdit.sku;
                        document.getElementById('product-category').value = productToEdit.category;
                        document.getElementById('product-cost-price').value = productToEdit.costPrice;
                        document.getElementById('product-sale-price').value = productToEdit.salePrice;
                        document.getElementById('product-current-stock').value = productToEdit.currentStock;
                        document.getElementById('product-min-stock').value = productToEdit.minStock;
                        document.getElementById('product-supplier-id').value = productToEdit.supplierId;

                        document.getElementById('product-submit-btn').textContent = 'Atualizar Produto';
                        document.getElementById('product-form-title').textContent = 'Editar Produto';
                        document.getElementById('product-cancel-edit-btn').classList.remove('hidden');
                    }
                });
            });

            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.id;
                    deleteProduct(productId);
                });
            });
        }

        function renderSuppliersTable() {
            const tableBody = document.getElementById('suppliers-table-body');
            tableBody.innerHTML = '';

            if (suppliers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="table-cell table-cell-subtext text-center">Nenhum fornecedor cadastrado.</td></tr>';
                return;
            }

            suppliers.forEach(supplier => {
                const row = `
                    <tr>
                        <td class="table-cell table-cell-text">${supplier.name}</td>
                        <td class="table-cell table-cell-subtext">${supplier.contact}</td>
                        <td class="table-cell table-cell-subtext">${supplier.address}</td>
                        <td class="table-cell text-right text-sm font-medium">
                            <button data-id="${supplier.id}" class="edit-supplier-btn text-green-600 hover:text-green-900 mr-4">Editar</button>
                            <button data-id="${supplier.id}" class="delete-supplier-btn text-red-600 hover:text-red-900">Remover</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // Add event listeners for new buttons
            document.querySelectorAll('.edit-supplier-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const supplierId = e.target.dataset.id;
                    const supplierToEdit = suppliers.find(s => s.id === supplierId);
                    if (supplierToEdit) {
                        document.getElementById('supplier-form').dataset.editingId = supplierId;
                        document.getElementById('supplier-name').value = supplierToEdit.name;
                        document.getElementById('supplier-contact').value = supplierToEdit.contact;
                        document.getElementById('supplier-address').value = supplierToEdit.address;
                        document.getElementById('supplier-payment-terms').value = supplierToEdit.paymentTerms;

                        document.getElementById('supplier-submit-btn').textContent = 'Atualizar Fornecedor';
                        document.getElementById('supplier-form-title').textContent = 'Editar Fornecedor';
                        document.getElementById('supplier-cancel-edit-btn').classList.remove('hidden');
                    }
                });
            });

            document.querySelectorAll('.delete-supplier-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const supplierId = e.target.dataset.id;
                    deleteSupplier(supplierId);
                });
            });
        }

        function renderSalesTable() {
            const tableBody = document.getElementById('sales-table-body');
            tableBody.innerHTML = '';

            if (sales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="table-cell table-cell-subtext text-center">Nenhuma venda registrada.</td></tr>';
                return;
            }

            sales.forEach(sale => {
                const product = products.find(p => p.id === sale.productId);
                const saleDate = sale.saleDate?.toDate ? sale.saleDate.toDate().toLocaleDateString() : (sale.saleDate || 'N/A');
                const row = `
                    <tr>
                        <td class="table-cell table-cell-text">${product?.name || 'Produto Desconhecido'}</td>
                        <td class="table-cell table-cell-subtext">${sale.quantity}</td>
                        <td class="table-cell table-cell-subtext">R$ ${(sale.quantity * sale.salePrice).toFixed(2)}</td>
                        <td class="table-cell table-cell-subtext">${saleDate}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderPurchasesTable() {
            const tableBody = document.getElementById('purchases-table-body');
            tableBody.innerHTML = '';

            if (purchases.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="table-cell table-cell-subtext text-center">Nenhuma compra registrada.</td></tr>';
                return;
            }

            purchases.forEach(purchase => {
                const product = products.find(p => p.id === purchase.productId);
                const supplier = suppliers.find(s => s.id === purchase.supplierId);
                const purchaseDate = purchase.purchaseDate?.toDate ? purchase.purchaseDate.toDate().toLocaleDateString() : (purchase.purchaseDate || 'N/A');
                const row = `
                    <tr>
                        <td class="table-cell table-cell-text">${product?.name || 'Produto Desconhecido'}</td>
                        <td class="table-cell table-cell-subtext">${supplier?.name || 'Fornecedor Desconhecido'}</td>
                        <td class="table-cell table-cell-subtext">${purchase.quantity}</td>
                        <td class="table-cell table-cell-subtext">R$ ${(purchase.quantity * purchase.costPrice).toFixed(2)}</td>
                        <td class="table-cell table-cell-subtext">${purchaseDate}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function updateDashboardKPIs() {
            const totalStockValue = products.reduce((sum, p) => sum + (p.currentStock * p.costPrice), 0);
            const lowStockProducts = products.filter(p => p.currentStock <= p.minStock);
            const totalSalesValue = sales.reduce((sum, s) => sum + (s.quantity * s.salePrice), 0);

            document.getElementById('total-stock-value').textContent = `R$ ${totalStockValue.toFixed(2)}`;
            document.getElementById('low-stock-products-count').textContent = lowStockProducts.length;
            document.getElementById('total-sales-value').textContent = `R$ ${totalSalesValue.toFixed(2)}`;
        }

        function populateProductSelects() {
            const productSelects = [
                document.getElementById('sale-product-id'),
                document.getElementById('purchase-product-id')
            ];
            const productFormSelect = document.getElementById('product-supplier-id'); // For product form's supplier select

            productSelects.forEach(select => {
                select.innerHTML = '<option value="">Selecione um produto</option>';
                products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.name} (Estoque: ${p.currentStock})`;
                    select.appendChild(option);
                });
            });

            // Populate supplier select in product form
            productFormSelect.innerHTML = '<option value="">Selecione um fornecedor</option>';
            suppliers.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                productFormSelect.appendChild(option);
            });
        }

        function populateSupplierSelects() {
            const supplierSelect = document.getElementById('purchase-supplier-id');
            supplierSelect.innerHTML = '<option value="">Selecione um fornecedor</option>';
            suppliers.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                supplierSelect.appendChild(option);
            });
        }

        // --- AI Integration (Placeholders) ---
        async function callGeminiAPI(prompt, schema = null) {
            showLoading();
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                if (schema) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    };
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (schema) {
                        try {
                            return JSON.parse(text);
                        } catch (jsonError) {
                            console.error("Erro ao parsear JSON da API Gemini:", jsonError);
                            showModal("Erro ao processar resposta da IA.", 'error');
                            return null;
                        }
                    }
                    return text;
                } else {
                    console.error("Resposta inesperada da API Gemini:", result);
                    showModal("Resposta inesperada da IA.", 'error');
                    return null;
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                showModal(`Erro ao chamar a IA: ${error.message}`, 'error');
                return null;
            } finally {
                hideLoading();
            }
        }

        async function predictDemand() {
            const salesData = sales.map(s => ({ productId: s.productId, quantity: s.quantity, date: s.saleDate?.toDate ? s.saleDate.toDate().toISOString().split('T')[0] : s.saleDate }));
            const prompt = `Com base nos seguintes dados de vendas históricas: ${JSON.stringify(salesData)}, preveja a demanda futura para cada produto nos próximos 3 meses. Forneça a previsão em um formato JSON como: [{"productId": "id_do_produto", "month": "YYYY-MM", "predictedQuantity": 123}].`;

            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        productId: { type: "STRING" },
                        month: { type: "STRING" },
                        predictedQuantity: { type: "NUMBER" }
                    },
                    propertyOrdering: ["productId", "month", "predictedQuantity"]
                }
            };

            const prediction = await callGeminiAPI(prompt, schema);
            if (prediction) {
                document.getElementById('ai-prediction-type').textContent = 'Previsão de Demanda';
                document.getElementById('ai-prediction-data').textContent = JSON.stringify(prediction, null, 2);
                document.getElementById('ai-predictions-output').classList.remove('hidden');
                showModal("Previsão de demanda gerada!", 'success');
            } else {
                showModal("Não foi possível gerar a previsão de demanda.", 'error');
            }
        }

        async function optimizeReplenishment() {
            const currentStock = products.map(p => ({ productId: p.id, currentStock: p.currentStock, minStock: p.minStock, supplierId: p.supplierId }));
            const prompt = `Com base no estoque atual: ${JSON.stringify(currentStock)} e nas previsões de demanda (se houver, use as últimas geradas ou considere uma demanda média), sugira pedidos de reabastecimento para cada produto, incluindo a quantidade e o fornecedor. Forneça em um formato JSON como: [{"productId": "id_do_produto", "quantityToOrder": 50, "supplierId": "id_do_fornecedor"}].`;

            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        productId: { type: "STRING" },
                        quantityToOrder: { type: "NUMBER" },
                        supplierId: { type: "STRING" }
                    },
                    propertyOrdering: ["productId", "quantityToOrder", "supplierId"]
                }
            };

            const replenishment = await callGeminiAPI(prompt, schema);
            if (replenishment) {
                document.getElementById('ai-prediction-type').textContent = 'Sugestões de Reabastecimento';
                document.getElementById('ai-prediction-data').textContent = JSON.stringify(replenishment, null, 2);
                document.getElementById('ai-predictions-output').classList.remove('hidden');
                showModal("Sugestões de reabastecimento geradas!", 'success');
            } else {
                showModal("Não foi possível gerar sugestões de reabastecimento.", 'error');
            }
        }

        async function detectAnomalies() {
            const allMovements = [
                ...sales.map(s => ({ type: 'sale', productId: s.productId, quantity: s.quantity, date: s.saleDate?.toDate ? s.saleDate.toDate().toISOString().split('T')[0] : s.saleDate })),
                ...purchases.map(p => ({ type: 'purchase', productId: p.productId, quantity: p.quantity, date: p.purchaseDate?.toDate ? p.purchaseDate.toDate().toISOString().split('T')[0] : p.purchaseDate })),
            ];
            const prompt = `Analise os seguintes movimentos de estoque: ${JSON.stringify(allMovements)}. Identifique quaisquer anomalias (picos incomuns, quedas inesperadas, etc.) e explique o que elas podem indicar. Forneça em um formato JSON como: [{"type": "anomaly", "description": "descrição da anomalia", "productId": "id_do_produto_afetado", "date": "data_da_anomalia"}].`;

            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        type: { type: "STRING" },
                        description: { type: "STRING" },
                        productId: { type: "STRING" },
                        date: { type: "STRING" }
                    },
                    propertyOrdering: ["type", "description", "productId", "date"]
                }
            };

            const anomalies = await callGeminiAPI(prompt, schema);
            if (anomalies) {
                document.getElementById('ai-prediction-type').textContent = 'Anomalias Detectadas';
                document.getElementById('ai-prediction-data').textContent = JSON.stringify(anomalies, null, 2);
                document.getElementById('ai-predictions-output').classList.remove('hidden');
                showModal("Anomalias detectadas!", 'success');
            } else {
                showModal("Não foi possível detectar anomalias.", 'error');
            }
        }

        async function analyzeProductPerformance() {
            const productSales = products.map(p => {
                const totalSold = sales.filter(s => s.productId === p.id).reduce((sum, s) => sum + s.quantity, 0);
                return { productId: p.id, name: p.name, totalSold, currentStock: p.currentStock };
            });
            const prompt = `Analise o desempenho dos seguintes produtos com base nas vendas: ${JSON.stringify(productSales)}. Identifique os produtos mais vendidos, os menos vendidos e sugira ações para melhorar o desempenho. Forneça em um formato JSON como: [{"productId": "id_do_produto", "performance": "bom/ruim/médio", "recommendation": "sugestão de ação"}].`;

            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        productId: { type: "STRING" },
                        performance: { type: "STRING" },
                        recommendation: { type: "STRING" }
                    },
                    propertyOrdering: ["productId", "performance", "recommendation"]
                }
            };

            const performance = await callGeminiAPI(prompt, schema);
            if (performance) {
                document.getElementById('ai-prediction-type').textContent = 'Análise de Desempenho de Produtos';
                document.getElementById('ai-prediction-data').textContent = JSON.stringify(performance, null, 2);
                document.getElementById('ai-predictions-output').classList.remove('hidden');
                showModal("Análise de desempenho de produtos gerada!", 'success');
            } else {
                showModal("Não foi possível analisar o desempenho dos produtos.", 'error');
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Initialize Firebase
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                currentAppIdForFirestorePath = firebaseConfig.appId; // Store for Firestore paths

                // Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    hideLoading();
                    if (user) {
                        currentUserId = user.uid;
                        userIdText.textContent = currentUserId;
                        authFormsSection.classList.add('hidden');
                        mainNav.classList.remove('hidden');
                        userInfoDisplay.classList.remove('hidden');
                        renderView('dashboard-section'); // Show dashboard after login
                        setupFirestoreListeners(currentUserId); // Start listening to data
                    } else {
                        currentUserId = null;
                        userIdText.textContent = "Nenhum usuário";
                        authFormsSection.classList.remove('hidden');
                        loginFormContainer.classList.remove('hidden');
                        registerFormContainer.classList.add('hidden');
                        mainNav.classList.add('hidden');
                        userInfoDisplay.classList.add('hidden');
                        // Hide all content sections when logged out
                        contentSections.forEach(section => section.classList.add('hidden'));
                    }
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                firebaseErrorDisplay.textContent = `Erro ao inicializar Firebase: ${error.message}. Verifique sua configuração.`;
                firebaseErrorDisplay.classList.remove('hidden');
                hideLoading();
            }

            // Auth form switches
            document.getElementById('switch-to-register').addEventListener('click', () => {
                loginFormContainer.classList.add('hidden');
                registerFormContainer.classList.remove('hidden');
            });
            document.getElementById('switch-to-login').addEventListener('click', () => {
                registerFormContainer.classList.add('hidden');
                loginFormContainer.classList.remove('hidden');
            });

            // Auth form submissions
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            logoutButton.addEventListener('click', handleLogout);

            // Navigation tabs
            navTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    renderView(e.target.dataset.target);
                });
            });

            // Product Form Submission
            document.getElementById('product-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const productData = {
                    name: form['product-name'].value,
                    description: form['product-description'].value,
                    sku: form['product-sku'].value,
                    category: form['product-category'].value,
                    costPrice: parseFloat(form['product-cost-price'].value),
                    salePrice: parseFloat(form['product-sale-price'].value),
                    currentStock: parseInt(form['product-current-stock'].value),
                    minStock: parseInt(form['product-min-stock'].value),
                    supplierId: form['product-supplier-id'].value,
                };
                const editingId = form.dataset.editingId;
                if (editingId) {
                    updateProduct(editingId, productData);
                } else {
                    addProduct(productData);
                }
            });
            document.getElementById('product-cancel-edit-btn').addEventListener('click', () => {
                document.getElementById('product-form').reset();
                document.getElementById('product-form').dataset.editingId = '';
                document.getElementById('product-submit-btn').textContent = 'Adicionar Produto';
                document.getElementById('product-form-title').textContent = 'Adicionar Novo Produto';
                document.getElementById('product-cancel-edit-btn').classList.add('hidden');
            });

            // Supplier Form Submission
            document.getElementById('supplier-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const supplierData = {
                    name: form['supplier-name'].value,
                    contact: form['supplier-contact'].value,
                    address: form['supplier-address'].value,
                    paymentTerms: form['supplier-payment-terms'].value,
                };
                const editingId = form.dataset.editingId;
                if (editingId) {
                    updateSupplier(editingId, supplierData);
                } else {
                    addSupplier(supplierData);
                }
            });
            document.getElementById('supplier-cancel-edit-btn').addEventListener('click', () => {
                document.getElementById('supplier-form').reset();
                document.getElementById('supplier-form').dataset.editingId = '';
                document.getElementById('supplier-submit-btn').textContent = 'Adicionar Fornecedor';
                document.getElementById('supplier-form-title').textContent = 'Adicionar Novo Fornecedor';
                document.getElementById('supplier-cancel-edit-btn').classList.add('hidden');
            });

            // Sale Form Submission
            document.getElementById('sale-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const saleData = {
                    productId: form['sale-product-id'].value,
                    quantity: parseInt(form['sale-quantity'].value),
                    salePrice: parseFloat(form['sale-price'].value),
                    saleDate: form['sale-date'].value,
                };
                addSale(saleData);
            });

            // Purchase Form Submission
            document.getElementById('purchase-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const purchaseData = {
                    productId: form['purchase-product-id'].value,
                    supplierId: form['purchase-supplier-id'].value,
                    quantity: parseInt(form['purchase-quantity'].value),
                    costPrice: parseFloat(form['purchase-cost-price'].value),
                    purchaseDate: form['purchase-date'].value,
                };
                addPurchase(purchaseData);
            });

            // AI Action Buttons
            document.getElementById('predict-demand-btn').addEventListener('click', predictDemand);
            document.getElementById('optimize-replenishment-btn').addEventListener('click', optimizeReplenishment);
            document.getElementById('detect-anomalies-btn').addEventListener('click', detectAnomalies);
            document.getElementById('analyze-performance-btn').addEventListener('click', analyzeProductPerformance);
        });
    </script>
</body>
</html>
